<!DOCTYPE html>
<html lang="fi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mielentila-tarkistus</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background: #1a1a1a;
      color: #eee;
      line-height: 1.6;
      margin: 0;
      text-align: center;
    }
    #box {
      background: #2c2c2c;
      padding: 22px;
      border-radius: 14px;
      box-shadow: 0 4px 14px rgba(0,0,0,0.5);
      margin-top: 40px;
    }
    .question {
      font-size: 1.8rem;
      margin-bottom: 20px;
      font-weight: 600;
    }
    .small-note {
      font-size: 1rem;
      opacity: 0.75;
      margin-top: 14px;
    }
    #startBtn {
      margin-top: 30px;
      padding: 20px;
      font-size: 1.4rem;
      background: #4CAF50;
      color: white;
      border: none;
      border-radius: 10px;
      width: 90%;
      max-width: 300px;
      cursor: pointer;
    }
  </style>
</head>
<body>

<h2>Mielentila-tarkistus</h2>

<button id="startBtn">KÄYNNISTÄ KUUNTELU</button>

<div id="box" style="display:none;">
  <div class="question" id="question"></div>
  <div class="small-note">Sano: "jatkuu", "stop", "kyllä" tai "ei".</div>
</div>

<script>
let started = false;

// -------------------- PUHEEN SYNTETISOINTI --------------------
function speak(msg) {
  const utter = new SpeechSynthesisUtterance(msg);
  utter.lang = "fi-FI";
  utter.rate = 1.0;
  utter.pitch = 1.0;
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);
}

// -------------------- KESKUSTELUN LOGIIKKA --------------------
const questions = [
  "Onko hengitys tänään suhteellisen tasainen?",
  "Tuntuuko kehossa enemmän jännitystä kuin rentoutta?",
  "Onko ajatuksia, jotka yrittävät rynniä päälle?",
  "Onko sisällä levottomuutta?",
  "Tuntuuko, että hallitset tämän hetken?",
  "Haluatko edetä tänään rauha ensin linjalla?"
];

let qIndex = -1;
let listening = false;
let stopped = false;

// -------------- PUHEENTUNNISTUS -------------
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new SpeechRecognition();
rec.continuous = true;
rec.lang = "fi-FI";

rec.onresult = (event) => {
  const text = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();

  if (text.includes("stop")) {
    stopped = true;
    show("Keskeytetty. Sano 'jatkuu' jatkaaksesi.");
    return;
  }
  if (text.includes("jatkuu")) {
    stopped = false;
    next();
    return;
  }
  if (!stopped && listening && (text.includes("kyllä") || text.includes("ei"))) {
    next();
  }
};

rec.onend = () => { if (started) rec.start(); };
rec.onerror = (e) => console.log("Speech error:", e);

// -------------- UI & TTS --------------
function show(msg) {
  document.getElementById("question").textContent = msg;
  speak(msg);
}

function next() {
  listening = true;
  qIndex++;

  if (qIndex >= questions.length) {
    show("Valmis tältä erää. Sano 'jatkuu' aloittaaksesi uudelleen.");
    qIndex = -1;
    listening = false;
    return;
  }

  show(questions[qIndex]);
}

// -------------- START BUTTON --------------
document.getElementById("startBtn").onclick = () => {
  // Android sallii nyt puheen
  started = true;

  // Piilota nappi
  document.getElementById("startBtn").style.display = "none";
  document.getElementById("box").style.display = "block";

  rec.start();
  show("Sano 'jatkuu' aloittaaksesi tarkistuksen.");
};
</script>

</body>
</html>
