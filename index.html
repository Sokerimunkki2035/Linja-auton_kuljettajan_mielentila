// -------------------- PUHESYNTEESI --------------------
function speakText(text) {
  const utter = new SpeechSynthesisUtterance(text);
  utter.lang = "fi-FI";
  utter.rate = 1.0;
  utter.pitch = 1.0;

  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(utter);

  return utter;
}

// -------------------- KYSYMYKSET --------------------
const questions = [
  "Onko hengitys tänään suhteellisen tasainen?",
  "Tuntuuko kehossa enemmän jännitystä kuin rentoutta?",
  "Onko ajatuksia, jotka yrittävät rynniä päälle?",
  "Onko sisällä levottomuutta?",
  "Tuntuuko, että hallitset tämän hetken?",
  "Haluatko edetä tänään rauha ensin linjalla?"
];

let qIndex = -1;
let stopped = false;
let started = false;

// -------------------- PUHEENTUNNISTUS --------------------
const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
const rec = new SpeechRecognition();
rec.lang = "fi-FI";
rec.continuous = true;
rec.interimResults = false;

rec.onresult = (event) => {
  const spoken = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();

  if (spoken.includes("stop")) {
    stopped = true;
    showAndSpeak("Keskeytetty. Sano 'jatkuu' jatkaaksesi.");
    return;
  }

  if (spoken.includes("jatkuu")) {
    stopped = false;
    nextQuestion();
    return;
  }

  if (!stopped && (spoken.includes("kyllä") || spoken.includes("ei"))) {
    nextQuestion();
  }
};

rec.onend = () => {
  if (started && !stopped) {
    try { rec.start(); } catch(e) {}
  }
};

// -------------------- NÄYTÄ + PUHU --------------------
function showAndSpeak(text) {
  document.getElementById("question").textContent = text;

  const utter = speakText(text);

  utter.onend = () => {
    if (started && !stopped) {
      try { rec.start(); } catch(e) {}
    }
  };
}

// -------------------- SEURAAVA KYSYMYS --------------------
function nextQuestion() {
  qIndex++;

  if (qIndex >= questions.length) {
    showAndSpeak("Valmis tältä erää. Sano 'jatkuu' aloittaaksesi uudelleen.");
    qIndex = -1;
    return;
  }

  try { rec.stop(); } catch(e) {}

  showAndSpeak(questions[qIndex]);
}

// -------------------- START BUTTON --------------------
document.getElementById("startBtn").onclick = () => {
  started = true;

  document.getElementById("startBtn").style.display = "none";
  document.getElementById("box").style.display = "block";

  showAndSpeak("Sano 'jatkuu' aloittaaksesi tarkistuksen.");
};
